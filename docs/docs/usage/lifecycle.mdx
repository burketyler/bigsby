# Lifecycle

The Bigsby request lifecycle is composed of a number of stages that revolve around validation, parsing,
authentication, execution and error handling.

<div style={{ display: "flex", justifyContent: "center" }}>
  <a href={"/bigsby/img/request-lifecycle-diagram.png"} target={"_blank"}>
    <img
      src={"/bigsby/img/request-lifecycle-diagram.png"}
      alt={"Request Lifecycle"}
    />
  </a>
</div>

## Hooks

Bigsby exposes hooks that enable the creation of complex and powerful request workflows. Each hook accepts
an array of functions known as `HookChains`. Hooks can be used to perform special startup or shutdown operations,
transform request/response payloads, or add metadata to the `RequestContext`. Many hooks can even be used to
[takeover](#response-takeover) the `ApiResponse` a handler returns.

:::tip

All hooks are asynchronous, they're called in the order they appear in the input array, and they receive the
`RequestContext` of the invocation (some hooks may receive additional inputs too, see below).

:::

### onInit

The `onInit` hook chain is called a single time when the Lambda handler instance is first invoked, before any
other stage in the lifecycle. It receives the Bigsby instance the hook is registered; it cannot takeover the response.

### preInvoke

The `preInvoke` hook chain is called before any other stage in the lifecycle, on each invocation of the handler.

### preAuth

The `preAuth` hook chain is called immediately prior to any [authenticator](./authentication#authenticators) or
[AuthScheme](./authentication#auth-scheme) attached to a handler. If no authentication is attached to the handler,
it won't be called.

### onAuthFail

The `onAuthFail` hook chain is called when a request fails authentication. In addition to the request context,
it receives the [Error](./authentication#denying-a-request) thrown by the authenticator.

### preValidate

The `preValidate` hook chain is called immediately prior to request [validation](./validation#request). If no request
validation is attached to the handler, it won't be called.

### preParse

The `preParse` hook chain is called immediately prior to processing the incoming API Gateway event payload, including
the execution of any [event parsing](./event-parsing) instructions.

### onRequestInvalid

The `onRequestInvalid` hook chain is called in two scenarios:

- The Joi request schema validation fails.
- An error occurred when Bigsby attempted to parse the incoming API Gateway event.

In addition to the request context, the hook receives either the [ValidationError](https://joi.dev/api/?v=17.6.0#validationerror)
returned by Joi, or the `RequestParseError` generated by Bigsby.

### preExecute

The `preExecute` hook chain is called immediately prior to the invoke method of the handler class being called.

### preResponse

The `preResponse` hook chain is called immediately prior to Bigsby returning a response, during an invocation
that is returning normally. In addition to the request context, it receives the `ApiResponse` object representing
the outgoing response.

### onResponseInvalid

The `onResponseInvalid` hook chain is called in two scenarios:

- The Joi response schema validation fails.
- An error occurred when Bigsby attempted to create the `ApiResponse` from the handler's return value.

In addition to the request context, the hook receives either the [ValidationError](https://joi.dev/api/?v=17.6.0#validationerror)
returned by Joi, or the `TypeCoercionError` generated by Bigsby.

:::info

Response schema validation errors are considered internal errors because they indicate a breaking change to the response contract.
Bigsby errors during creation of an `ApiResponse` are also considered internal errors. Because of this, the [onError](#onerror)
hook will be called after `onResponseInvalid`.

:::

### onError

The `onError` hook chain is called when an unhandled exception occurs during the execution of the handler, or while
calling any hook chain that isn't expected to throw an error.

## Response Takeover

Hooks (except [onInit](#oninit)) can 'takeover' a handler's response by optionally returning an `ApiResponse`. If this occurs,
the handler will discontinue the request lifecycle and instead immediately return the response following the completion
of the hook chain. Each hook in the chain will receive the original inputs, plus a `ResponseBuilder` representing the `ApiResponse`
returned by the previous hook in the chain, or undefined.
